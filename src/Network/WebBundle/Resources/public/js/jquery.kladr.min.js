(function(a){a.kladr={};a.kladr.url="http://kladr-api.ru/api.php";a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"};a.kladr.api=function(c,e){var b={};if(c.token){b.token=c.token}if(c.key){b.key=c.key}if(c.type){b.contentType=c.type}if(c.name){b.query=c.name}if(c.parentType&&c.parentId){b[c.parentType+"Id"]=c.parentId}if(c.withParents){b.withParent=1}b.limit=c.limit?c.limit:2000;var d=false;a.getJSON(a.kladr.url+"?callback=?",b,function(f){if(d){return}d=true;e&&e(f.result)});setTimeout(function(){if(d){return}d=true;console.error("Request error");e&&e([])},5000)};a.kladr.check=function(b,c){b.withParents=false;b.limit=1;a.kladr.api(b,function(d){if(d&&d.length){c&&c(d[0])}else{c&&c(false)}})}})(jQuery);(function(b,a){b.fn.kladr=function(e,f){var d=a;this.each(function(){var g=c(b(this),e,f);if(d==a){d=g}});return d;function c(B,n,t){var w=null;var A=null;var z=null;var i={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,arrowSelect:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(G,H){var F={token:z.token,key:z.token,type:z.type,name:G,parentType:z.parentType,parentId:z.parentId,withParents:z.withParents,limit:z.limit};b.kladr.api(F,H)},labelFormat:function(I,G){var F="";var J=I.name.toLowerCase();G=G.toLowerCase();var H=J.indexOf(G);H=H>0?H:0;if(I.typeShort){F+=I.typeShort+". "}if(G.length<I.name.length){F+=I.name.substr(0,H);F+="<strong>"+I.name.substr(H,G.length)+"</strong>";F+=I.name.substr(H+G.length,I.name.length-G.length-H)}else{F+="<strong>"+I.name+"</strong>"}return F},valueFormat:function(G,F){return G.name}};var C={up:38,down:40,esc:27,enter:13};var s=null;return r(n,t,function(){var F=false;h();D();B.keyup(x);B.keydown(g);B.change(function(){if(!F){j()}});B.blur(function(){if(!F){E()}});w.on("click","li, a",m);w.on("mouseenter","li",function(){var H=b(this);w.find("li.active").removeClass("active");H.addClass("active");var G=H.find("a").data("kladr-object");v("preselect",G);F=true});w.on("mouseleave","li",function(){b(this).removeClass("active");F=false});b(window).resize(D)});function r(G,H,I){z=B.data("kladr-options");if(H!==a){z[G]=H;B.data("kladr-options",z);return B}if(b.type(G)==="string"){if(!z){return null}return z[G]}if(z){return B}z=i;if(b.type(G)==="object"){for(var F in G){z[F]=G[F]}}B.data("kladr-options",z);I&&I();return B}function h(){var G=b(document.getElementById("kladr_autocomplete"));var F=B.attr("name");if(!G.length){G=b('<div id="kladr_autocomplete"></div>').appendTo("body")}B.attr("autocomplete","off");w=b('<ul class="kladr_autocomplete_'+F+'" style="display: none;"></ul>');w.appendTo(G);A=b('<div class="spinner kladr_autocomplete_'+F+'_spinner" class="spinner" style="display: none;"></div>');A.appendTo(G)}function k(J,L){w.empty();for(var G in J){var M=J[G];var F=z.valueFormat(M,L);var H=z.labelFormat(M,L);var I=b('<a data-val="'+F+'">'+H+"</a>");I.data("kladr-object",M);var K=b("<li></li>").append(I);K.appendTo(w)}}function D(){var F=B.offset();var H=B.outerWidth();var G=B.outerHeight();w.css({top:F.top+G+"px",left:F.left});var K=w.outerWidth()-w.width();w.width(H-K);var I=A.width();var J=A.height();A.css({top:F.top+(G-J)/2-1,left:F.left+H-I-2,})}function x(G){if((G.which>8)&&(G.which<46)){return}if(!y()){return}var F=p(B.val());if(!b.trim(F)){E();return}u();v("send");z.source(F,function(H){q();v("received");if(!B.is(":focus")){E();return}if(!b.trim(B.val())||!H.length){E();return}k(H,F);D();w.slideDown(50);v("open")})}function E(){l();w.hide();v("close")}function y(){switch(z.type){case b.kladr.type.region:case b.kladr.type.district:case b.kladr.type.city:if(z.parentType&&!z.parentId){console.error("parentType is defined and parentId in not");return false}break;case b.kladr.type.street:if(z.parentType!=b.kladr.type.city){console.error('For street parentType must equal "city"');return false}if(!z.parentId){console.error("For street parentId must defined");return false}break;case b.kladr.type.building:if(z.parentType!=b.kladr.type.street){console.error('For building parentType must equal "street"');return false}if(!z.parentId){console.error("For building parentId must defined");return false}break;default:console.error('type must defined and equal "region", "district", "city", "street" or "building"');return false}if(z.limit<1){console.error("limit must greater than 0");return false}return true}function l(){var F=w.find(".active a");if(!F.length){return}B.val(F.attr("data-val"));z.current=F.data("kladr-object");B.data("kladr-options",z);v("select",z.current)}function g(G){var F=w.find("li.active");switch(G.which){case C.up:if(F.length){F.removeClass("active");F=F.prev()}else{F=w.find("li").last()}F.addClass("active");var H=F.find("a").data("kladr-object");v("preselect",H);if(z.arrowSelect){l()}break;case C.down:if(F.length){F.removeClass("active");F=F.next()}else{F=w.find("li").first()}F.addClass("active");var H=F.find("a").data("kladr-object");v("preselect",H);if(z.arrowSelect){l()}break;case C.esc:F.removeClass("active");E();break;case C.enter:if(!z.arrowSelect){l()}F.removeClass("active");E();return false}}function m(){E();B.focus();return false}function j(){if(!z.verify){return}if(!y()){return}var F=p(B.val());if(!b.trim(F)){return}u();v("send");z.source(F,function(I){q();v("received");var J=null;for(var H=0;H<I.length;H++){var G=F.toLowerCase();var K=I[H].name.toLowerCase();if(G==K){J=I[H];break}}if(J){B.val(z.valueFormat(J,F))}z.current=J;B.data("kladr-options",z);v("check",z.current)})}function p(I){var J="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var G="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var L="";var H;var K;for(var F=0;F<I.length;F++){H=I[F];K=J.indexOf(H);if(K>-1){L+=G[K];continue}L+=H}return L}function v(F,G){if(!F){return}B.trigger("kladr_"+F,G);if(z[F]){z[F].call(B.get(0),G)}}function o(){if(s){return}var F=-0.2;s=setInterval(function(){if(!A.is(":visible")){clearInterval(s);s=null;return}A.css("background-position","0% "+F+"%");F+=5.555556;if(F>95){F=-0.2}},30)}function u(){if(z.showSpinner){A.show();o()}}function q(){A.hide()}}}})(jQuery);
